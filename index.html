<!DOCTYPE html>
<html>
<head>
	<title>Duo-Pong</title>
	<meta name="author" content="Dmitrii Cucleschin / Nikolce Kolev / Stefan Mirea">
	<meta description="A game of ping-pong, played on shared screen of two computers. Made as CS Club demo for Jacobs University Club Fair by Dmitrii Cucleschin, Nikolce Kolev and Stefan Mirea.">
	<meta name="keywords" content="ping-pong, ping, pong, javascript, demo, dual, two-player, automatic, game">
	<style>
		body {padding: 0; margin: 0; overflow: hidden;}
	</style>
</head>

<body>
	<canvas id="canvas"></canvas>
</body>

<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
  var socket = io.connect('http://localhost');

  socket.emit('init', {
  	screenWidth: window.innerWidth || document.documentElement.clientWidth,
    screenHeight: window.innerHeight || document.documentElement.clientHeight
  });

  handler('init', startGame);
  handler('updateBall', updateBall);

  /**
   * Register a global socket handler
   * @param  {string}   name     the name of the handler
   * @param  {Function} callback the function to call
   */
  function handler (name, callback) {
  	socket.on(name, function () {
  		console.info('[socket] %s', name, arguments);
  		callback.apply(callback, Array.prototype.slice.call(arguments));
  	});
  }

	// Sets screen animation to 60 fps to ensure smooth animations.
	window.requestAnimFrame = (function(){
		return  window.requestAnimationFrame 	||
			window.webkitRequestAnimationFrame 	||
			window.mozRequestAnimationFrame 	||
			window.oRequestAnimationFrame 		||
			window.msRequestAnimationFrame 		||
			function( callback ){
				return window.setTimeout(callback, 1000 / 60);
			};
	})();

	// Stop animating when game has ended.
	window.cancelRequestAnimFrame = ( function() {
	return window.cancelAnimationFrame 				||
		window.webkitCancelRequestAnimationFrame 	||
		window.mozCancelRequestAnimationFrame 		||
		window.oCancelRequestAnimationFrame 		||
		window.msCancelRequestAnimationFrame 		||
		clearTimeout
	} )();

	// Initialize needed variables.
	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d");
	var width = window.innerWidth;
	var height = window.innerHeight;
	var player_type = null;
	var ball = {
		x: 0,
		y: 0,
		r: 0,
		color: "white",
		vx: 0,
		vy: 0,

		draw: function() {
			ctx.beginPath();
			ctx.fillStyle = this.color;
			ctx.arc(this.x, this.y, this.r, 0, Math.PI*2, false);
			ctx.fill();
		}
	};
	var mouse = {x:0, y:0};
	var my_score = 0;
	var enemy_score = 0;
	var fps = 60;
	var init;

	// Make canvas equal to screen dimensions and set listeners.
	canvas.width = width;
	canvas.height = height;
	canvas.addEventListener("mousemove", mouseMoved, true);

	// Define properties of the paddle.
	var paddle = new (function () {
		var offset = 5;

  		this.h = 200;
		this.w = 20;
		this.x = (player_type === "left") ? offset : (width - this.w - offset);
		this.y = height/2 - this.h/2;
		this.color = "white";

		this.draw = function() {
			ctx.fillStyle = this.color;
			ctx.fillRect(this.x,this.y,this.w,this.h);
		};
	})();

	// Syncs ball coordinates with the server.
	function updateBall(b) {
		for (var key in b) {
		  ball[key] = b[key];
		}
	}

	// Fills canvas' background.
	function paintCanvas() {
		ctx.fillStyle = "black";
		ctx.fillRect(0,0,width,height);
	}

	// Game logic.
	function update() {
		// Move paddle according to mouse movement
		if (mouse.x && mouse.y) {
			paddle.y = mouse.y - paddle.h/2;
		}

		// Move ball according to current velocity
		ball.x += ball.vx;
		ball.y += ball.vy;
		
		if (ball.x < 0 || ball.x > width) {
			console.log("Collision with left/right");
			didCollide(ball,"vertical");
		}
		else if (ball.y < 0 || ball.y > height) {
			console.log("Collision with top/bottom");
			didCollide(ball,"horizontal");
		}
		else if (intersects(ball,paddle)) {
			console.log("Collision with paddle: ", paddle);
			didCollide(ball,"paddle");
		}
	}

	function intersects(circle, rect) {
		var circleDist = {x:0, y:0};
		circleDist.x = Math.abs(circle.x - rect.x - rect.w/2);
		circleDist.y = Math.abs(circle.y - rect.y - rect.h/2);

		if (circleDist.x > (rect.w/2 + circle.r))
			return false;

		if (circleDist.y > (rect.h/2 + circle.r))
			return false;

		if (circleDist.x <= (rect.w/2))
			return true;

		if (circleDist.y <= (rect.h/2))
			return true;

		var cornerDist = Math.pow((circleDist.x - rect.w/2),2) + Math.pow((circleDist.y - rect.h/2),2);
		return (cornerDist <= Math.pow(circle.r,2));
	}

	function didCollide (ball, success) {
		socket.emit('didCollide', {
			success: success,
			ball: ball
		});
	}

	// Update current mouse coordinates.
	function mouseMoved(e) {
		mouse.x = e.pageX;
		mouse.y = e.pageY;
	}

	// Defines drawing of the single frame of the game.
	function draw() {
		paintCanvas();

		ball.draw();
		paddle.draw();

		update();
	}

	// Loop, that keeps repeating during the game to keep animation running.
	function animationLoop() {
		init = requestAnimFrame(animationLoop);
		draw();
	}

	// Action, that starts the game.
	function startGame(initData) {
		if (!initData.ball) {
			console.warn('Ball object not found', ball);
			return;
		}

		player_type = initData.playerType;
		updateBall(initData.ball);
		animationLoop();
	}

</script>
</html>